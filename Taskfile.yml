version: '3'

vars:
  BINARY_NAME: refresh
  BUILD_DIR: ./dist
  DEFAULT_CLUSTER: development-blue

env:
  CGO_ENABLED: 0

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # Build tasks
  build:
    desc: Build the binary
    cmds:
      - go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}} .
    generates:
      - "{{.BUILD_DIR}}/{{.BINARY_NAME}}"

  build:release:
    desc: Build release binary with optimizations
    cmds:
      - go build -ldflags="-s -w -X github.com/dantech2000/refresh/internal/commands.version={{.VERSION}} -X github.com/dantech2000/refresh/internal/commands.commit={{.COMMIT}} -X github.com/dantech2000/refresh/internal/commands.buildDate={{.DATE}}" -o {{.BUILD_DIR}}/{{.BINARY_NAME}} .
    vars:
      VERSION:
        sh: git describe --tags --always --dirty
      COMMIT:
        sh: git rev-parse --short HEAD
      DATE:
        sh: date -u +%Y-%m-%dT%H:%M:%SZ
    generates:
      - "{{.BUILD_DIR}}/{{.BINARY_NAME}}"

  # Development tasks
  dev:
    desc: Build and install locally for development
    deps: [build]
    cmds:
      - cp {{.BUILD_DIR}}/{{.BINARY_NAME}} .

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BUILD_DIR}}
      - rm -f {{.BINARY_NAME}}
      - rm -f coverage.out coverage.html

  # Code quality tasks
  fmt:
    desc: Format Go code
    cmds:
      - go fmt ./...

  lint:
    desc: Run golangci-lint
    cmds:
      - golangci-lint run

  vet:
    desc: Run go vet
    cmds:
      - go vet ./...

  test:
    desc: Run tests
    cmds:
      - go test -v ./...

  test:coverage:
    desc: Run tests with coverage
    cmds:
      - go test -v -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "Coverage report generated at coverage.html"

  # Dependency management
  deps:
    desc: Download and tidy dependencies
    cmds:
      - go mod download
      - go mod tidy

  deps:update:
    desc: Update dependencies
    cmds:
      - go get -u ./...
      - go mod tidy

  # Local testing commands
  run:version:
    desc: Test version command
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} version

  run:help:
    desc: Show help
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} --help

  run:cluster:list:
    desc: Test cluster list command (requires AWS credentials)
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} cluster list

  run:ng:list:
    desc: Test nodegroup list command (requires AWS credentials and cluster)
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} ng list -c {{.DEFAULT_CLUSTER}}

  run:ng:update:dry:
    desc: Test nodegroup update-ami dry run (requires AWS credentials and cluster)
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} ng update-ami -c {{.DEFAULT_CLUSTER}} --dry-run

  # Development workflow shortcuts
  dev:quick:
    desc: Quick development test cycle (format, vet, build, version)
    cmds:
      - task: fmt
      - task: vet
      - task: build
      - task: run:version
      - echo "✅ Quick check passed!"

  dev:full:
    desc: Full development check (format, vet, lint, test, build)
    cmds:
      - task: fmt
      - task: vet
      - task: lint
      - task: test
      - task: build
      - task: run:version
      - task: run:help
      - echo "✅ Full development check passed!"

  # AWS/EKS testing helpers
  aws:check:
    desc: Check AWS credentials and configuration
    cmds:
      - aws sts get-caller-identity
      - aws eks list-clusters --query 'clusters[*]' --output table

  # Release tasks
  release:check:
    desc: Check if ready for release
    cmds:
      - task: dev:full
      - git status --porcelain
      - echo "✅ Ready for release!"

  release:test:
    desc: Test GoReleaser configuration without releasing
    cmds:
      - goreleaser check
      - goreleaser build --snapshot --clean

  release:dry:
    desc: Dry run of the full release process
    cmds:
      - goreleaser release --snapshot --clean

  release:tag:
    desc: Create and push a release tag based on version.go
    cmds:
      - |
        VERSION=$(grep -oP 'version\s*=\s*"\Kv[^"]+' internal/commands/version.go)
        if [ -z "$VERSION" ]; then
          echo "Could not extract version from version.go"
          exit 1
        fi
        echo "Creating tag: $VERSION"
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"

  # Man page installation
  install:man:
    desc: Install man page using the built-in command (no sudo required)
    deps: [build]
    cmds:
      - ./{{.BUILD_DIR}}/{{.BINARY_NAME}} install-man
